<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改商品')" />
    <th:block th:include="include :: bootstrap-fileinput-css"/>
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-spu-edit" th:object="${hxbSpu}">
            <input name="id" th:field="*{id}" type="hidden">
            <h4 class="form-header h4">基本信息</h4>
            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">标题：</label>
                        <div class="col-sm-8">
                            <input name="title" th:field="*{title}" class="form-control" type="text">
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">小标题：</label>
                        <div class="col-sm-8">
                            <input name="titleMinor" th:field="*{titleMinor}" class="form-control" type="text">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">logo：</label>
                        <div class="col-sm-8">
                            <input type="hidden" name="logo" th:field="*{logo}">
                            <div class="file-loading">
                                <input class="form-control file-upload" id="logo" name="file" type="file">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">图片：</label>
                        <div class="col-sm-8">
                            <input type="hidden" name="banner" th:field="*{banner}">
                            <div class="file-loading">
                                <input class="form-control file-upload" id="banner" name="file" type="file">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <h4 class="form-header h4">权益设置</h4>
        <a class="btn btn-success" onclick="aa()" >
            <i class="fa fa-plus"></i> 添加
        </a>
        <form class="form-horizontal m" id="form-spuvalue-edit"  th:object="${hxbSpu}">
            <div id="list" >
                <div  class="row" th:each="item : *{hxbSpuValueList}">
                    <input name="id" th:value="${item.id}" type="hidden">
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">标题：</label>
                            <div class="col-sm-8">
                                <input name="name" th:value="${item.name}" class="form-control" type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">销售价格：</label>
                            <div class="col-sm-8">
                                <input name="salesPrice" th:value="${item.salesPrice}" class="form-control" type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">市场价格：</label>
                            <div class="col-sm-8">
                                <input name="marketPrice" th:value="${item.marketPrice}" class="form-control" type="text">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="xz"> </div>
        </form>
        <h4 class="form-header h4">权益详情</h4>
        <a id="spudetails"  class="btn btn-success" onclick="spudetail()" >
            <i class="fa fa-plus"></i> 添加
        </a>
        <form class="form-horizontal m" id="form-spudetail-edit" th:object="${hxbSpu}">
            <div class="row"  >
                <div class="col-sm-4">
                    <div class="form-group">
                        <label class="col-sm-3 control-label is-required">展示类型：</label>
                        <div class="col-sm-8">
                            <label class="radio-box"> <input type="radio" th:field="*{detailsType}" name="detailsType" value="M" /> 海报 </label>
                            <label class="radio-box"> <input type="radio" th:field="*{detailsType}" name="detailsType" value="C" /> 文字 </label>
                        </div>
                    </div>
                </div>
                <div class="col-sm-8"></div>
            </div>
            <div id="wenzi">
                <div class="row" th:each="item : *{HxbSpuDetailsList}">
                    <input name="id" th:value="${item.id}" type="hidden">
                    <div class="col-sm-4">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">名称：</label>
                            <div class="col-sm-8">
                                <input id="detailsName" th:value="${item.detailsName}"  name="detailsName" class="form-control" type="text">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-8">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">介绍：</label>
                            <div class="col-sm-8">
                                <textarea id="detailsContent" name="detailsContent" class="form-control" type="text">[[${item.detailsContent}]]</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="xzqy"> </div>
            <div class="row" id="haibao"   >
               <input name="id" th:value="*{HxbSpuDetailsList[0].id}" type="hidden">
                <div class="col-sm-4">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">海报：</label>
                        <div class="col-sm-8">
                            <input type="hidden" name="detailsPosters" th:value="*{HxbSpuDetailsList[0].detailsPosters}">
                            <div class="file-loading">
                                <input class="form-control file-upload" id="detailsPosters" name="file" type="file">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div class="row">
            <div class="col-sm-offset-5 col-sm-10">
                <button type="button" class="btn btn-sm btn-primary" onclick="submitHandler()"><i class="fa fa-check"></i>保 存</button>&nbsp;
                <button type="button" class="btn btn-sm btn-danger" onclick="closeItem()"><i class="fa fa-reply-all"></i>关 闭 </button>
            </div>
        </div>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-fileinput-js"/>
    <script th:inline="javascript">
        var a = 0;
        var detail = 0;
        var type;
        //拿取detailsType值获取类型
        // var type = $('#form-spu-edit').find("input[name='detailsType']").val();
        //赋值给点选框
        // $('input:radio[name="menuType"][value= '+type+' ]').prop('checked', true);
        //根据类型动态显隐
        // if (type == "M") {
        //     $("#wenzi").hide();
        //     $("#haibao").show();
        //     $("#spudetails").hide();
        // } else if (type == "C") {
        //     $("#wenzi").show();
        //     $("#haibao").hide();
        //     $("#spudetails").show();
        // }
        $(function() {
            var menuType = $('input[name="detailsType"]:checked').val();
            type = menuType;
            menuVisible(menuType);
        });
        $(function() {
            $('input').on('ifChecked',
            function(event) {
                var menuType = $(event.target).val();
                type = menuType;
                menuVisible(menuType);
            });
        });

        var prefix = ctx + "system/spu";
        $("#form-spu-edit").validate({
            focusCleanup: true
        });
        function menuVisible(menuType) {
            if (menuType == "M") {
                $("#wenzi").hide();
                $("#haibao").show();
                $("#spudetails").hide();

            } else if (menuType == "C") {
                $("#wenzi").show();
                $("#haibao").hide();
                $("#spudetails").show();

            }
        }
        function submitHandler() {
            //权益设置
            var datas = []
            var tb = $('#list');
            var trs = tb.children();//.children()方法获取tbody的子元素
            $.each(trs, function (i, n) {//jquery迭代器,用于循环数组和json  i表示索引   n表示当前循环的元素
                var id = $(n).find("input[name='id']").val();
                var name = $(n).find("input[name='name']").val();
                var salesPrice = $(n).find("input[name='salesPrice']").val();
                var marketPrice = $(n).find("input[name='marketPrice']").val();
                var data = {//json对象   {key:value}
                    "id": id,
                    "name": name,
                    "salesPrice": salesPrice,
                    "marketPrice": marketPrice
                };

                datas.push(data);//数组的push方法
            });
            var tbxz = $('#xz');
            var trsxz = tbxz.children();//.children()方法获取tbody的子元素
            $.each(trsxz, function (i, n) {//jquery迭代器,用于循环数组和json  i表示索引   n表示当前循环的元素
                var name = $(n).find("input[name='name']").val();
                var salesPrice = $(n).find("input[name='salesPrice']").val();
                var marketPrice = $(n).find("input[name='marketPrice']").val();
                var data = {//json对象   {key:value}
                    "name": name,
                    "salesPrice": salesPrice,
                    "marketPrice": marketPrice
                };
                datas.push(data);//数组的push方法
            });
            var requestData = JSON.stringify(datas)
            //权益详情
            var spudatas = []
            if(type == "M"){
                var spudata = {//json对象   {key:value}
                    "id":  $('#form-spudetail-edit').find("input[name='id']").val(),
                    "detailsPosters":  $('#form-spudetail-edit').find("input[name='detailsPosters']").val()
                };
                spudatas.push(spudata)
            }else if(type == "C"){
                var tb = $('#wenzi');
                var trs = tb.children();//.children()方法获取tbody的子元素
                $.each(trs, function (i, n) {//jquery迭代器,用于循环数组和json  i表示索引   n表示当前循环的元素
                    var detailsName = $(n).find("input[name='detailsName']").val();
                    var detailsContent = $(n).find("textarea[name='detailsContent']").val();
                    var spudata = {//json对象   {key:value}
                        "detailsName": detailsName,
                        "detailsContent": detailsContent
                    };
                    spudatas.push(spudata)//数组的push方法
                });
                var tb1 = $('#xzqy');
                var trs1 = tb1.children();//.children()方法获取tbody的子元素
                $.each(trs1, function (i, n) {//jquery迭代器,用于循环数组和json  i表示索引   n表示当前循环的元素
                    var detailsName = $(n).find("input[name='detailsName']").val();
                    var detailsContent = $(n).find("textarea[name='detailsContent']").val();
                    var spudata = {//json对象   {key:value}
                        "detailsName": detailsName,
                        "detailsContent": detailsContent
                    };
                    spudatas.push(spudata)//数组的push方法
                });
            }
            var spuData = JSON.stringify(spudatas)
            var spu = $('#form-spu-edit').serializeArray()
            spu.push({"name": "hxbSpuValue", "value": requestData});
            spu.push({"name": "hxbSpuDetails", "value": spuData});
            spu.push({"name": "detailsType", "value": type});
            if ($.validate.form()) {
                $.operate.saveTab(prefix + "/edit", spu);
            }
        }
        function aa(){
            var str = "<div id="+a+" class=\"row\">\n" +
                "                <div class=\"col-sm-4\">\n" +
                "                    <div class=\"form-group\">\n" +
                "                        <label class=\"col-sm-3 control-label\">名称：</label>\n" +
                "                        <div class=\"col-sm-8\">\n" +
                "                            <input name=\"name\" class=\"form-control\" type=\"text\">\n" +
                "                        </div>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "                <div class=\"col-sm-4\">\n" +
                "                    <div class=\"form-group\">\n" +
                "                        <label class=\"col-sm-3 control-label\">销售价格：</label>\n" +
                "                        <div class=\"col-sm-8\">\n" +
                "                            <input name=\"salesPrice\" class=\"form-control\" type=\"text\">\n" +
                "                        </div>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "                <div class=\"col-sm-4\">\n" +
                "                    <div class=\"form-group\">\n" +
                "                        <label class=\"col-sm-3 control-label\">市场价格：</label>\n" +
                "                        <div class=\"col-sm-8\">\n" +
                "                            <input name=\"marketPrice\" class=\"form-control\" type=\"text\">\n" +
                "                        </div>\n" +
                "                   <button onclick=\"bb("+a+")\">删除</button>  </div>\n" +
                "               </div>\n" +
                "             </div>";
            a++;
            $("#xz").append(str);
        }
        function bb(e){
            $("div#"+e+"").remove();
        }
        function spudetail(){
            var str = "<div id= s"+detail+" class=\"row\">\n" +
                "                <div class=\"col-sm-4\">\n" +
                "                    <div class=\"form-group\">\n" +
                "                        <label class=\"col-sm-3 control-label\">名称：</label>\n" +
                "                        <div class=\"col-sm-8\">\n" +
                "                            <input id=\"detailsName\" name=\"detailsName\" class=\"form-control\" type=\"text\">\n" +
                "                        </div>\n" +
                "                    </div>\n" +
                "                </div>\n" +
                "                <div class=\"col-sm-8\">\n" +
                "                    <div class=\"form-group\">\n" +
                "                        <label class=\"col-sm-3 control-label\">介绍：</label>\n" +
                "                        <div class=\"col-sm-8\">\n" +
                "                            <textarea id=\"detailsContent\" name=\"detailsContent\" class=\"form-control\" type=\"text\"></textarea>\n" +
                "                        </div>\n" +
                "                    <button onclick=\"delspudetail("+detail+")\">删除</button>  </div>\n" +
                "                </div>\n" +
                "            </div>";
            detail++;
            $("#xzqy").append(str);
        }
        function delspudetail(e){
            $("div#s"+e+"").remove();
        }


        $(".file-upload").each(function (i) {
            var val = $("input[name='" + this.id + "']").val()
            $(this).fileinput({
                'uploadUrl': ctx + 'common/upload',
                initialPreviewAsData: true,
                initialPreview: [val],
                maxFileCount: 1,
                autoReplace: true
            }).on('fileuploaded', function (event, data, previewId, index) {
                $("input[name='" + event.currentTarget.id + "']").val(data.response.url)
            }).on('fileremoved', function (event, id, index) {
                $("input[name='" + event.currentTarget.id + "']").val('')
            })
            $(this).fileinput('_initFileActions');
        });
    </script>
</body>
</html>